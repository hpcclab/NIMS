# run coordinator
docker run -d --name=coordinator -p 30001:5000 -e ORCHESTRATOR_TYPE=mesos -e MARATHON_URL=http://172.17.0.1:8088 -v /var/run/docker.sock:/var/run/docker.sock core.harbor.example.nip.io/migration/migration-coordinator

# run memhog dind
{
  "id": "default-memhog",
  "mem": 256,
  "networks": [ { "mode": "container/bridge" } ],
  "container": {
    "type": "DOCKER",
    "docker": {
      "image": "${REGISTRY}migration-dind:latest",
      "privileged": true,
      "parameters": [
                { "key": "env", "value": "DOCKER_HOST=127.0.0.1:2375" },
                { "key": "env", "value": "LOG_LEVEL=debug" },
                { "key": "label", "value": "kubectl.kubernetes.io/last-applied-configuration={\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"annotations\":{\"migration-engine\":\"dind\",\"migration-migratable\":\"true\"},\"labels\":{\"app\":\"memhog\"},\"name\":\"memhog\",\"namespace\":\"default\"},\"spec\":{\"containers\":[{\"env\":[{\"name\":\"MEMORY_REQUEST\",\"value\":\"0\"},{\"name\":\"MEMORY_LIMIT\",\"value\":\"128\"},{\"name\":\"MEMORY_INCREMENT\",\"value\":\"128\"},{\"name\":\"SHOULD_CONTINUE\",\"value\":\"true\"}],\"image\":\"${REGISTRY}memhog:latest\",\"name\":\"memhog\"}],\"serviceAccountName\":\"migration-coordinator\"}}\n" },
                { "key": "label", "value": "migration-containers=[{\"env\": [{\"name\": \"MEMORY_REQUEST\", \"value\": \"0\"}, {\"name\": \"MEMORY_LIMIT\", \"value\": \"128\"}, {\"name\": \"MEMORY_INCREMENT\", \"value\": \"128\"}, {\"name\": \"SHOULD_CONTINUE\", \"value\": \"true\"}], \"image\": \"${REGISTRY}memhog:latest\", \"name\": \"memhog\"}]"},
                { "key": "label", "value": "migration-app=default-memhog"},
                { "key": "label", "value": "migration-migratable=True"},
                { "key": "label", "value": "migration-start-mode=active"},
                { "key": "label", "value": "migration-engine=dind"},
                { "key": "memory", "value": "0"},
                { "key": "cpu-shares", "value": "0"}
            ]
    },
    "volumes": [
      {
        "containerPath": "/var/lib/docker",
        "hostPath": "/dev/shm/cache",
        "mode": "RW"
      },
      {
        "containerPath": "/etc/podinfo/annotations",
        "hostPath": "/home/hpcclab/annotations",
        "mode": "RW"
      }
    ]
  }
}

{
  "id": "default-memhog-monitor",
  "container": {
    "type": "DOCKER",
    "docker": {
      "image": "${REGISTRY}migration-monitor:latest",
      "parameters": [
                { "key": "env", "value": "DOCKER_HOST=172.17.0.3:2375" },
                { "key": "env", "value": "CONTAINER_NAME=memhog" },
                { "key": "env", "value": "API_SERVER=172.17.0.3:8888" },
                { "key": "label", "value": "migration-app=default-memhog-monitor"}
            ]
    }
  }
}

{
  "id": "default-memhog",
  "mem": 256,
  "networks": [ { "mode": "container/bridge" } ],
  "container": {
    "type": "DOCKER",
    "docker": {
      "image": "${REGISTRY}memhogff:latest",
      "parameters": [
                { "key": "env", "value": "MEMORY_REQUEST=0" },
                { "key": "env", "value": "MEMORY_LIMIT=128" },
                { "key": "env", "value": "MEMORY_INCREMENT=128" },
                { "key": "env", "value": "SHOULD_CONTINUE=true" },
                { "key": "label", "value": "kubectl.kubernetes.io/last-applied-configuration={\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"annotations\":{\"migration-migratable\":\"true\"},\"labels\":{\"app\":\"memhog\"},\"name\":\"memhog\",\"namespace\":\"default\"},\"spec\":{\"containers\":[{\"command\":null,\"env\":[{\"name\":\"MEMORY_REQUEST\",\"value\":\"0\"},{\"name\":\"MEMORY_LIMIT\",\"value\":\"128\"},{\"name\":\"MEMORY_INCREMENT\",\"value\":\"128\"},{\"name\":\"SHOULD_CONTINUE\",\"value\":\"true\"}],\"image\":\"${REGISTRY}memhogff:latest\",\"name\":\"memhog\"}],\"serviceAccountName\":\"migration-coordinator\"}}\n"},
                { "key": "label", "value": "migration-app=default-memhog"},
                { "key": "label", "value": "migration-migratable=True"},
                { "key": "label", "value": "migration-start-mode=active"},
                { "key": "label", "value": "migration-volumes={}"},
                { "key": "cap-add", "value": "SYS_PTRACE"},
                { "key": "memory", "value": "0"},
                { "key": "cpu-shares", "value": "0"}
            ]
    },
    "volumes": [
      {
        "containerPath": "/etc/podinfo/annotations",
        "hostPath": "/home/hpcclab/annotations",
        "mode": "RW"
      }
    ]
  }
}